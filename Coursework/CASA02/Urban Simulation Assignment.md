_This is the assignment for the UCL CASA module Urban Simulation (CASA0002)_
_Code & data is hosted and availble at [Github](https://github.com/X-Fan-Jack/Study_Notes/tree/master/Coursework/CASA02)_

# Part 1: London’s underground resilience:
## I. Topological network:
In this section, the data of the London tube network in csv format provided on Moodle will be used.  The network model can be generated by using the data, only the topological relationships between nodes are considered, and the network is named as **_G_**.

### 1.1 Centrality measures:
Centrality measures of a network are used to measure the importance of nodes in the network in different aspects. These important aspects can include the influence of nodes in terms of information dissemination, control, influence, and connectivity. In this section, three measures will be used: Degree centrality, Closeness centrality and Betweenness centrality.    

_**Degree Centrality**_ (DC) is a commonly used centrality metric to measure the importance or centrality of nodes in a network. In London tube networks, degree centrality can be used to assess the interactivity of stations, i.e., the number of direct connections to other stations. DC measures the number of direct connections of a node in the network, i.e., the degree of the node. A higher degree of a node indicates more direct connections to other nodes and thus plays a more important role in the network.    
For a node $i$ in an undirected network, degree centrality can be calculated by the following equation:
$$C_{d}(i) = \frac{k_i}{N-1} $$
where $C_d(i)$ means the degree centrality of node $i$, $k_i$ denotes the number of degrees of node $i$ (i.e., the number of edges directly connected to node $i$), and $N$ means the total number of nodes in the network. 

**_Closeness Centrality_** (CC) is a metric used to measure the closeness between nodes and other nodes in a network. Closeness centrality measures the average shortest path length from a node to other nodes, i.e., the average distance between a node and other nodes. A higher proximity centrality of a node indicates that the distance between the node and other nodes is shorter and the connection is tighter.  In the London tube network, Closeness centrality indicates the average shortest path of a station to other stations, and the higher the value, the shorter the journey to the rest of the stations in the network and the more important the station is.
For a node $i$ in an undirected network, closeness centrality can be calculated by the following equation:
$$C_{c}(i) = \frac{N-1}{ {\textstyle \sum_{j=1}^{N}} d(i,j)} $$  
where $C_c(i)$ means the closeness centrality of node i, $d(i,j)$ means the shortest path length from node $i$ to node $j$, and $N$ means the total number of nodes in the network.  

_**Betweenness Centrality**_ (BC) is used to measure the extent to which a node acts as a mediator in the network, i.e., how often a node is on the shortest path between connecting other nodes. Nodes with high betweenness centrality usually have strong information transfer and control capabilities in the network. The higher the betweenness centrality of a node, the more frequently the node acts as an intermediary in the network and plays an important role in the connectivity and information transfer of the network. In the London tube network, the value of betweenness centrality indicates the importance of the station as a transit station, and the higher the value, the more important the station is as a transit point. 
For a node $i$ in an undirected network, betweenness centrality can be calculated by the following equation: 
$$C_B(v) = \sum_{s,t \in V} \frac{\sigma(s, t|v)}{\sigma(s, t)}$$
where $C_B(v)$ means the betweenness centrality of node $i$. $V$ is the set of nodes. $\sigma(s, t)$ is the number of shortest $(s, t)$-paths, and $\sigma(s, t|v)$ is the number of those paths passing through some node $v$ other than $s,t$. if $s=t, \sigma(s, t)=1$ and if $v \in {s, t}, \sigma(s, t|v) = 0$.   

Based on the network G, the DC, CC and BC ranking of each station in the London tube network can be calculated, and the top 10 of them are shown in the following table:   

|Rank|station_name|degree_centrality|station_name|closeness_centrality|station_name|betweenness_centrality|
|--|--|--|--|--|--|--|
|1|Stratford|0.922111|Stratford|0.927739|Stratford|0.098553|
|2|Highbury & Islington|0.806533|Highbury & Islington|0.836134|Liverpool Street|0.034307|
|3|Whitechapel|0.781407|Whitechapel|0.820619|Canary Wharf|0.027956|
|4|West Brompton|0.776382|West Brompton|0.817248|Bank and Monument|0.027956|
|5|Canada Water|0.771357|Canada Water|0.813906|Canning Town|0.027757|
|6|Canary Wharf|0.771357|Richmond|0.810591|West Ham|0.024551|
|7|Liverpool Street|0.768844|Canary Wharf|0.810591|Highbury & Islington|0.023023|
|8|Bank and Monument|0.766332|Bank and Monument|0.810591|Whitechapel|0.019682|
|9|Richmond|0.766332|Liverpool Street|0.808943|Canada Water|0.017898|
|10|Canning Town|0.763819|Canning Town|0.808943|Shadwell|0.017070|

### 1.2 Impact measures:

In order to measure the impact of station closure on the whole London tube network, this section will use two coefficients to evaluate the overall characteristics of the network. These two coefficients are: **_Average Clustering Coefficient_** and **_Degree Assortativity Coefficient_**.

**_Average clustering coefficient_** (ACC) reflects the average of the clustering coefficients of all nodes in the network. The clustering coefficient is a measure of how tightly connected a node is to its neighbors, and it measures the connectivity between a node's neighbors. For the London tube network, the neighbors of a station are the other stations adjacent to it, so the clustering coefficient reflects the degree of connectivity between stations in the subway network. The higher the average clustering coefficient, the tighter the connectivity between stations in the tube network.  

**_Degree assortativity coefficient_** (DAC) directly reflects the correlation between the degrees of nodes in the network, and indirectly reflects the structural characteristics of the network. For the London tube networks, if there is positive degree assortativity in the network, then neighboring stations are usually connected with similar number of other stations, forming a tightly connected community structure. On the contrary, if there is negative degree assortativity in the tube network, then adjacent stations are usually connected to other stations with widely varying numbers, forming a more dispersed structure.

By removing the nodes and recalculating the two coefficients, the network's resilience can be evaluated by the change of the two coefficients. If it remains unchanged or increases, it means that the network is more resilient, which means that the network is able to retain the original characteristics as much as possible. If the coefficients decreases, then it means that the network is not resilient in the corresponding metric, or the node has a greater impact on a network.   

These two measures can reflect the characteristics of the shape and clustering of the arbitrary network, which are not specific to the London tube network. For whether using these two metrics to evaluate the resilience of an arbitrary network will be significant, we need to consider factors such as the network's own characteristics. For example, if we are more concerned with the change in resilience of a network in terms of the degree of aggregation, then for an arbitrary network we would be more inclined to focus on the change in the average aggregation coefficient of that network as the nodes change.

### 1.3 Node removal:
Two strategies based on three central measure rankings, using sequential and non-sequential deletion of nodes, generated two results affecting the variation of the coefficients, as shown in the following figure:    
![[output1_3.png]]
从结果图中可以看出，BC能够更好的反映出车站对于地下运行的重要性。因为在ACC和DAC两种测量尺度下，随着节点的删除，BC的变化情况是较为离散的。与近似线性变化的DC和CC相比，BC变化的离散性更能体现出不同车站的关闭对于网络整体的影响大小不同。这在理论上与现实生活中车站的重要性差异具有非线性的特征相对应。同时，BC体现出了车站作为中转节点的重要性。因此，BC更好的反映出车站对于地下运行的重要性。但是，由于该方法只考虑了拓扑网络，所以使用这种方法去计算真实车站的重要程度仍具有一定的限制。   

从结果图中可以看出，Non-sequential和Sequential两种删除策略对于DC和CC两种centrality measures在两类系数的变化上影响不大，但对于BC的影响较为显著。

~~Non-sequential 删除策略对于研究网络的resilience更加有效。因为相较于Sequential 删除策略，Non-sequential 删除策略使得ACC和DAC两种指标系数下降的更快，更容易帮助我们得知关闭某个车站后对整个地铁网络结构特征的破坏程度的大小，进而更好的帮助我们研究网络的resilience。~~ 

~~对于哪种影响度量能更好地评估节点移除后的损害，我认为ACC相比于DAC能更好的评估节点移除后的网络损伤。尽管在结果图中，相较于ACC，DAC受节点移除的数值下降更显著。但DAC的取值范围是从-1到1。当DAC为正时，表示网络中度值高的节点更倾向于连接到其他度值高的节点，网络具有正相关性。当DAC为负时，表示网络中度值高的节点更倾向于连接到度值低的节点，网络具有负相关性，因此DAC的值在$[-1,-0.5)\cup (0.5,1]$内才会具有较强的实际意义。从结果图中可以看出，DAC作为影响度量其值在$(-0.5,0.25)$内，即网络中节点的度值与其他节点的度值没有明显的相关性，不能准确判断网络的状态。而ACC直接反映了网络的连接紧密程度，因此我认为ACC能更好的评估节点移除后的网络损伤。~~

<hr>

## II. Flows: weighted network:
### II.1. Old vs new measure:
当我们将客流量纳入到London Tube 网络考虑时，网络的每一个edge都会增加一个edge的字段。这表明网络变成了一个加权网络。此时，在1.1中描述的三种Centrality measures将需要重新考虑。首先，DC是不变的，因为DC的计算方法只考虑了节点的度，并不考虑网络的权重，因此DC是不变的。其次，对于CC和BC，因为是将人流量作为权重加入到计算，因此将人流量的归一化结果作为权重。同时，因为CC和BC的节点重要性是根据距离成本来计算的，距离成本的意义与人流量的意义是相反的，因此最终需要取归一化结果与1的差值作为权重成本。经过计算，CC和BC的结果变化如下：    

|Rank|name|cc|name|cc_weight|name|bc|name|bc_weight|
|--|--|--|--|--|--|--|--|--|
| 1 | Stratford | 0.927739 | Stratford | 0.944876 | Stratford | 0.098553 | Stratford | 0.132384 |
| 2 | Highbury & Islington | 0.836134 | Liverpool Street | 0.869680 | Liverpool Street | 0.034307 | Bank and Monument | 0.125460 |
| 3 | Whitechapel | 0.820619 | Highbury & Islington | 0.851008 | Canary Wharf | 0.027956 | Canada Water | 0.063178 |
| 4 | West Brompton | 0.817248 | Canary Wharf | 0.847229 | Bank and Monument | 0.027956 | Liverpool Street | 0.061327 |
| 5 | Canada Water | 0.813906 | Bank and Monument | 0.838551 | Canning Town | 0.027757 | Waterloo | 0.046047 |
| 6 | Richmond | 0.810591 | Waterloo | 0.838551 | West Ham | 0.024551 | Highbury & Islington | 0.028894 |
| 7 | Canary Wharf | 0.810591 | Whitechapel | 0.827934 | Highbury & Islington | 0.023023 | Seven Sisters | 0.024588 |
| 8 | Bank and Monument | 0.810591 | Canada Water | 0.826647 | Whitechapel | 0.019682 | Barking | 0.021002 |
| 9 | Liverpool Street | 0.808943 | Canning Town | 0.823384 | Canada Water | 0.017898 | Canning Town | 0.019432 |
| 10 | Canning Town | 0.808943 | West Brompton | 0.822428 | Shadwell | 0.017070 | Canary Wharf | 0.017379 |

通过表格可以看出，若人流量作为权重加入到网络节点的重要性计算中时，网络节点的重要性排名出现了变化，比如在closeness centrality的变化中，Liverpool Street的站点重要性从第九名上升到了第二名。这说明了人流量的考虑将会改变站点的重要性排名。同时，Stratford站一直为第一名的状态，说明该站十分重要，不论是否考虑人流量。

### II.2. Impact measure with flows:
对于加权网络，在1.2 中使用的两种imapct measures仍可以使用，因为ACC和DAC的计算都支持加权网络的计算，也就是说这两种参数的计算可以包含网络权重。除此之外，对于加权网络，我们还可以使用平均最短路径长度(Average Shortest Path Length)，来评价网络的紧密程度。ASPL表示了所有节点对之间的最短路径长度的平均值。一般来说，平均最短路径长度越小，说明节点之间的联系越紧密，信息传播的速度越快。对于London地铁网络，该值越小，说明旅客从出发站到目的站所需要经过的平均站点数量越少。 如果关闭某车站，ASPL值增加，说明该站点的关闭使得旅客所经过的平均站点数量增加，ASPL值变化的越大，说明该站点的去除对于旅客的地铁使用体验的影响越大。

### III.3. Experiment with flows:
？？？？？

<hr>

# Part 2: Spatial Interaction models:
In this section, the data of the London tube OD matrix in csv format provided on Moodle will be used.  
## III. Models and calibration:
### III.1
#### Gravity Model
Gravity model is the spatial interaction model that was highlighted in the lecture. The gravity model is commonly defined as:  

$$T_{ij}=K\frac{O_i^{\alpha}D_j^{\gamma}}{d_{ij}^\beta } = KO_i^{\alpha}D_j^{\gamma}d_{ij}^{-\beta}$$
- Where $T_{ij}$ is the transition or flow $T$, between origin $i$ and destination $j$. 
- $O$ is a vector of origin attributes which relate to the emissiveness of all origins in the dataset, $i$ - means the index of the origin area. 
- $D$ is a vector of desination attributes which relate to the attractivenss of all destinations in the dataset, $j$ - means the index of the desination area. 
- $d$ is a matrix of costs relating to the flows between $i$ and $j$.
- $K$, $\alpha$, $\gamma$ and $β$ are all the model parameters to be estimated

This model shows that the flow between origin and destination is proportional to the product of the masses of origin and destination and inversely proportional to the distance between them. As the quality of the origin and destination increases, the flow increases, but as the distance increases, the flow decreases, and vice versa.    

On this basis, constraining the parameters can lead to a constrained gravity model. For example, the Production (orign) Constrained Spatial Interaction Model, which is used in practical, is a single constrained model with constraints on $O_i^{\alpha}$. In addition, there are also Attraction (destination) Constrained Spatial Interaction Models that constrain the destination value.    

The gravity model is the most basic spatial interaction model, which can represent the relationship between two locations. For example, the gravity model can represent the population attraction between two locations, A and B. This can explain the stronger population movement between large cities compared to that between small cities. 

#### Agent Based Model
In addition, the agent-based model(ABM) is introduced in the course as a spatial interaction model. It has good simulation effect for urban phenomena such as traffic congestion.Futhermore, the course also introduces the cellular automata model. Cellular automata models are a special class of ABMs that can well represent the self-similarity of urban sprawl based on fractal geometry.   

### III.2
The target of spatial interaction model is to models and predicts the number of occurrences of events in a certain time period. Thus, Poisson regression is chosen to build the prediction model. Because Poisson regression models assume that the response variables are Poisson distributed and model and predict count data better. As a result, we can build a constrained gravity model by using the formula: 
$$

T_{ij} = A_i O_i D_j d_{ij}^{-\beta}

$$Where$$

O_i = \sum_j T_{ij}

$$and$$

A_i = \frac{1}{\sum_j D_j d_{ij}^{-\beta}}

$$Thus, we can get the formula as:$$

\lambda_{ij} = \exp (\alpha_i + \delta \ln P_i + \epsilon \ln J_i - \beta \ln d_{ij})

$$Where $\alpha_i$ is the equivalent of the vector of balancing factors $A_i$, $P_i$ is the population of the origin area, $J_i$ is the jobs count in the origin area and $d_{ij}$ is the distance between OD.

Using Python, the Poisson regression model was built and the distance cost is calculated as: $\beta = -0.1556$ 

<hr>

## IV. Scenarios
## IV.1
## IV.2
## IV.3
# Appendix
